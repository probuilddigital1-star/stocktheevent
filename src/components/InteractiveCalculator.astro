---
import { items } from '../data/items';
import { events } from '../data/events';
import { guestCounts } from '../data/guestCounts';

// Pass data to client
const itemsData = items.map(i => ({
  id: i.id,
  name: i.name,
  emoji: i.emoji,
  unit: i.unit,
  unitSingular: i.unitSingular,
  servingsPerUnit: i.servingsPerUnit,
}));

const eventsData = events.map(e => ({
  id: e.id,
  name: e.name,
  slug: e.slug,
  defaultDuration: e.defaultDuration,
  modifiers: e.modifiers,
}));

const guestCountsData = guestCounts.map(g => ({
  value: g.value,
  label: g.label,
  tier: g.tier,
}));

// Drink category images (placeholder paths - can be replaced with actual images)
const drinkImages = {
  wine: '/images/wine-glass.jpg',
  beer: '/images/beer-glass.jpg',
  spirits: '/images/spirits-bottles.jpg',
  champagne: '/images/champagne-glass.jpg',
};

// Material icons for drinks
const drinkIcons = {
  wine: 'wine_bar',
  beer: 'sports_bar',
  spirits: 'liquor',
  champagne: 'local_bar',
};
---

<section class="py-12 md:py-20">
  <div class="max-w-5xl mx-auto px-4">
    <!-- Header -->
    <div class="text-center mb-10 animate-fade-in-up">
      <h1 class="font-display text-4xl md:text-5xl lg:text-6xl font-bold text-[var(--chocolate)] mb-4 leading-tight">
        Plan the Perfect Party
      </h1>
      <p class="text-lg text-[var(--chocolate-light)] max-w-2xl mx-auto">
        Calculate exactly what you need with our <span class="text-[var(--primary-dark)] font-semibold">bartender-tested formulas</span>
      </p>
      <p class="text-sm text-[var(--chocolate-40)] mt-2">336 drink + event + guest combinations available</p>
    </div>

    <div class="grid lg:grid-cols-2 gap-8 items-start">
      <!-- Input Panel -->
      <div class="glass-card p-6 md:p-8 animate-fade-in-up">
        <div class="space-y-8">
          <!-- Drink Type - Glass Cards Grid -->
          <div>
            <label class="block text-sm font-bold text-[var(--chocolate)] mb-2 uppercase tracking-wider">
              What are you serving?
            </label>
            <p class="text-sm text-[var(--chocolate-40)] mb-4">Select the categories for your event</p>
            <div class="grid grid-cols-2 gap-4" id="item-selector">
              {items.map((item, idx) => (
                <button
                  type="button"
                  data-item={item.id}
                  class:list={[
                    'drink-card group relative aspect-square rounded-2xl overflow-hidden transition-all duration-300',
                    idx === 0
                      ? 'glass-card-selected'
                      : 'glass-card hover:border-[var(--primary-40)]'
                  ]}
                >
                  <!-- Background gradient (simulating image) -->
                  <div class="absolute inset-0 bg-gradient-to-br from-[var(--champagne-100)] to-[var(--cream-200)] opacity-60 group-hover:opacity-80 transition-opacity"></div>

                  <!-- Material Icon -->
                  <span class:list={[
                    'material-symbols-outlined absolute top-3 left-3 text-xl transition-colors',
                    idx === 0 ? 'text-[var(--primary)]' : 'text-[var(--chocolate-40)] group-hover:text-[var(--primary)]'
                  ]} style="font-variation-settings: 'FILL' 0;">
                    {drinkIcons[item.id as keyof typeof drinkIcons]}
                  </span>

                  <!-- Content -->
                  <div class="absolute inset-0 flex flex-col items-center justify-center p-4">
                    <span class="text-5xl mb-2 group-hover:scale-110 transition-transform drop-shadow-md">{item.emoji}</span>
                    <span class="font-semibold text-[var(--chocolate)] text-lg">{item.name}</span>
                  </div>

                  <!-- Selection indicator -->
                  <div class:list={[
                    'selection-dot absolute top-3 right-3 w-3 h-3 rounded-full transition-all',
                    idx === 0 ? 'bg-[var(--primary)] scale-100' : 'bg-transparent scale-0'
                  ]}></div>
                </button>
              ))}
            </div>
            <div id="selection-count" class="text-center mt-4 text-sm text-[var(--primary-dark)] font-medium">
              1 drink selected
            </div>
          </div>

          <!-- Event Type -->
          <div>
            <label class="block text-sm font-bold text-[var(--chocolate)] mb-4 uppercase tracking-wider">
              What's the occasion?
            </label>
            <select id="event-select" class="w-full p-4 border-2 border-[var(--primary-30)] rounded-2xl bg-white/80 backdrop-blur-sm focus:ring-2 focus:ring-[var(--primary)] focus:border-[var(--primary)] text-lg text-[var(--chocolate)] hover:border-[var(--primary-40)] transition-colors cursor-pointer font-medium">
              {events.map(event => (
                <option value={event.id}>{event.name}</option>
              ))}
            </select>
          </div>

          <!-- Guest Count Slider -->
          <div>
            <div class="flex justify-between items-baseline mb-4">
              <label class="text-sm font-bold text-[var(--chocolate)] uppercase tracking-wider">
                Number of Guests
              </label>
              <span id="guest-display" class="font-mono-luxe text-3xl font-bold text-[var(--chocolate)]">100</span>
            </div>
            <div class="relative">
              <input
                type="range"
                id="guest-slider"
                min="0"
                max="100"
                value="33.33"
                step="0.1"
                class="w-full h-2 rounded-full appearance-none cursor-pointer slider-golden"
                style="background: linear-gradient(to right, var(--primary) 0%, var(--primary) 33.33%, var(--chocolate-10) 33.33%, var(--chocolate-10) 100%);"
              />
            </div>
            <!-- Labels evenly spaced with flexbox - piecewise scale aligns thumb with labels -->
            <div class="flex justify-between mt-2 text-xs text-[var(--chocolate-40)] font-medium">
              <span>10</span>
              <span>100</span>
              <span>200</span>
              <span>300</span>
            </div>
          </div>

          <!-- Duration Slider -->
          <div class="border-t border-[var(--primary-10)] pt-8">
            <div class="flex justify-between items-baseline mb-4">
              <label class="text-sm font-bold text-[var(--chocolate)] uppercase tracking-wider">
                Event Duration
              </label>
              <div class="flex items-baseline gap-1">
                <span id="duration-display" class="font-mono-luxe text-3xl font-bold text-[var(--chocolate)]">5</span>
                <span class="text-sm text-[var(--chocolate-40)] font-medium uppercase">hrs</span>
              </div>
            </div>
            <div class="relative">
              <input
                type="range"
                id="duration-slider"
                min="1"
                max="6"
                value="5"
                class="w-full h-2 rounded-full appearance-none cursor-pointer slider-golden"
                style="background: linear-gradient(to right, var(--primary) 0%, var(--primary) 80%, var(--chocolate-10) 80%, var(--chocolate-10) 100%);"
              />
            </div>
            <div class="flex justify-between mt-2 text-xs text-[var(--chocolate-40)] font-medium">
              <span>1hr</span>
              <span>2hr</span>
              <span>3hr</span>
              <span>4hr</span>
              <span>5hr</span>
              <span>6hr+</span>
            </div>
            <p id="duration-hint" class="text-center text-sm text-[var(--chocolate-40)] mt-3">
              Recommended for weddings
            </p>
          </div>
        </div>
      </div>

      <!-- Results Panel -->
      <div class="animate-fade-in-up animate-delay-100">
        <!-- Result Card with Sunset Gradient -->
        <div class="sunset-gradient rounded-3xl overflow-hidden flourish-corners">
          <!-- Single Drink Result (default) -->
          <div id="single-result" class="result-panel p-8 md:p-10 text-center text-white">
            <p class="text-sm uppercase tracking-widest opacity-80 mb-6">You will need approx.</p>
            <div id="result-emoji" class="text-7xl mb-4 drop-shadow-lg transition-transform">üç∑</div>
            <div class="flex items-baseline justify-center gap-2 mb-2">
              <span id="result-units" class="font-mono-luxe text-7xl md:text-8xl font-bold text-glow">24</span>
            </div>
            <div id="result-unit-label" class="font-display text-2xl italic opacity-95">Bottles</div>
            <div class="flex items-center justify-center gap-2 mt-4 text-sm opacity-80">
              <span class="material-symbols-outlined text-base">info</span>
              <span id="result-mix-label">Calculated for wine</span>
            </div>
          </div>

          <!-- Multi-Drink Result (2-3 drinks) -->
          <div id="multi-result" class="result-panel hidden p-6 text-center text-white">
            <p class="text-sm uppercase tracking-widest opacity-80 mb-4">Your Bar Setup</p>
            <div id="multi-drink-grid" class="grid gap-3">
              <!-- Dynamically populated -->
            </div>
            <div class="flex items-center justify-center gap-2 mt-4 text-sm opacity-80">
              <span class="material-symbols-outlined text-base">info</span>
              <span>15% buffer included on each</span>
            </div>
          </div>

          <!-- Full Bar Result (4 drinks) -->
          <div id="fullbar-result" class="result-panel hidden p-6 text-center text-white">
            <div class="text-4xl mb-2">üéâ</div>
            <p class="text-lg font-semibold mb-1">Your Complete Bar</p>
            <div id="total-items" class="font-mono-luxe text-5xl font-bold text-glow">106</div>
            <p class="text-sm opacity-80 mb-4">total items</p>
            <div id="fullbar-grid" class="grid grid-cols-2 gap-2">
              <!-- Dynamically populated -->
            </div>
          </div>
        </div>

        <!-- Stats Row -->
        <div class="grid grid-cols-3 gap-3 mt-4">
          <div class="glass-card p-4 text-center">
            <div id="result-servings" class="font-mono-luxe text-2xl font-bold text-[var(--chocolate)]">120</div>
            <div class="text-xs text-[var(--chocolate-40)] font-medium uppercase tracking-wide mt-1">servings</div>
          </div>
          <div class="glass-card p-4 text-center">
            <div id="result-per-person" class="font-mono-luxe text-2xl font-bold text-[var(--chocolate)]">1.2</div>
            <div class="text-xs text-[var(--chocolate-40)] font-medium uppercase tracking-wide mt-1">per person</div>
          </div>
          <div class="glass-card p-4 text-center">
            <div id="result-duration" class="font-mono-luxe text-2xl font-bold text-[var(--chocolate)]">5</div>
            <div class="text-xs text-[var(--chocolate-40)] font-medium uppercase tracking-wide mt-1">hours</div>
          </div>
        </div>

        <!-- CTA Button -->
        <a
          href="#"
          id="detail-link"
          class="block w-full forest-gradient text-white text-center py-4 rounded-2xl font-bold text-lg mt-4 hover:scale-[1.02] active:scale-[0.98] transition-transform flex items-center justify-center gap-2"
        >
          <span id="cta-text">Get Full Breakdown</span>
          <span class="material-symbols-outlined">arrow_forward</span>
        </a>
        <p class="text-center text-sm text-[var(--chocolate-40)] mt-3">
          Pro tips ‚Ä¢ Step-by-step math ‚Ä¢ Copy-ready shopping list
        </p>
      </div>
    </div>
  </div>
</section>

<style>
  /* Drink card specific styles */
  .drink-card.glass-card-selected .selection-dot {
    background: var(--primary);
    transform: scale(1);
  }

  .drink-card:not(.glass-card-selected) .selection-dot {
    background: transparent;
    transform: scale(0);
  }

  /* Multi-drink card style */
  .drink-card-item {
    background: rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    padding: 12px;
    backdrop-filter: blur(4px);
  }

  .drink-card-sm {
    background: rgba(255, 255, 255, 0.15);
    border-radius: 10px;
    padding: 8px 12px;
    backdrop-filter: blur(4px);
  }

  /* Result animation */
  @keyframes resultPop {
    0% { transform: scale(1); }
    50% { transform: scale(1.08); }
    100% { transform: scale(1); }
  }

  .result-animate {
    animation: resultPop 0.3s ease-out;
  }
</style>

<script define:vars={{ itemsData, eventsData, guestCountsData }}>
  // Bartender constants
  const BASE_DRINKS_PER_HOUR = 1.5;
  const BUFFER_PERCENTAGE = 0.15;
  const HOURLY_DECAY = [1.0, 0.9, 0.75, 0.6, 0.5, 0.45];
  const DRINKING_PERCENTAGE = {
    small: 0.80,
    medium: 0.75,
    large: 0.70,
    xlarge: 0.65,
  };

  // Event-specific drink splits
  const EVENT_SPLITS = {
    wedding: { wine: 0.45, beer: 0.30, champagne: 0.20, spirits: 0.25 },
    'super-bowl': { wine: 0.15, beer: 0.70, champagne: 0.05, spirits: 0.25 },
    corporate: { wine: 0.45, beer: 0.30, champagne: 0.15, spirits: 0.25 },
    birthday: { wine: 0.22, beer: 0.55, champagne: 0.08, spirits: 0.30 },
    'holiday-party': { wine: 0.40, beer: 0.20, champagne: 0.15, spirits: 0.40 },
    graduation: { wine: 0.28, beer: 0.50, champagne: 0.12, spirits: 0.25 },
    'wedding-shower': { wine: 0.40, beer: 0.08, champagne: 0.60, spirits: 0.10 },
  };

  const VARIETY_FACTORS = {
    1: 1.00,
    2: 1.25,
    3: 1.40,
    4: 1.60,
  };

  const MINIMUM_UNITS = {
    wine: 6,
    beer: 2,
    champagne: 4,
    spirits: 8,
  };

  // Calculate tier based on guest count
  function getTierFromGuestCount(guests) {
    if (guests <= 30) return 'small';
    if (guests <= 75) return 'medium';
    if (guests <= 150) return 'large';
    return 'xlarge';
  }

  // Piecewise linear conversion: slider position (0-100) to guest count (10-300)
  // Labels at 0%=10, 33.33%=100, 66.66%=200, 100%=300
  function sliderToGuests(sliderValue) {
    if (sliderValue <= 33.33) {
      // 0-33.33% maps to 10-100 guests
      return Math.round(10 + (sliderValue / 33.33) * 90);
    } else if (sliderValue <= 66.66) {
      // 33.33-66.66% maps to 100-200 guests
      return Math.round(100 + ((sliderValue - 33.33) / 33.33) * 100);
    } else {
      // 66.66-100% maps to 200-300 guests
      return Math.round(200 + ((sliderValue - 66.66) / 33.34) * 100);
    }
  }

  // Piecewise linear conversion: guest count (10-300) to slider position (0-100)
  function guestsToSlider(guests) {
    if (guests <= 100) {
      // 10-100 guests maps to 0-33.33%
      return ((guests - 10) / 90) * 33.33;
    } else if (guests <= 200) {
      // 100-200 guests maps to 33.33-66.66%
      return 33.33 + ((guests - 100) / 100) * 33.33;
    } else {
      // 200-300 guests maps to 66.66-100%
      return 66.66 + ((guests - 200) / 100) * 33.34;
    }
  }

  // Valid guest counts that have pre-generated pages
  const VALID_PAGE_GUESTS = [10, 15, 20, 25, 30, 40, 50, 75, 100, 125, 150, 200, 250, 300];

  // Find nearest valid guest count for URL path
  function getNearestValidGuests(guests) {
    let closest = VALID_PAGE_GUESTS[0];
    let minDiff = Math.abs(guests - closest);
    for (const valid of VALID_PAGE_GUESTS) {
      const diff = Math.abs(guests - valid);
      if (diff < minDiff) {
        minDiff = diff;
        closest = valid;
      }
    }
    return closest;
  }

  // State
  let selectedItems = [itemsData[0]];
  let selectedEvent = eventsData[0];
  let selectedGuestCount = { value: 100, tier: 'large' }; // 100 guests default
  let selectedDuration = eventsData[0].defaultDuration;

  // DOM elements
  const drinkCards = document.querySelectorAll('.drink-card');
  const eventSelect = document.getElementById('event-select');
  const guestSlider = document.getElementById('guest-slider');
  const durationSlider = document.getElementById('duration-slider');
  const guestDisplay = document.getElementById('guest-display');
  const durationDisplay = document.getElementById('duration-display');
  const durationHint = document.getElementById('duration-hint');
  const selectionCount = document.getElementById('selection-count');

  // Result panels
  const singleResult = document.getElementById('single-result');
  const multiResult = document.getElementById('multi-result');
  const fullbarResult = document.getElementById('fullbar-result');

  // Single result elements
  const resultEmoji = document.getElementById('result-emoji');
  const resultUnits = document.getElementById('result-units');
  const resultUnitLabel = document.getElementById('result-unit-label');
  const resultMixLabel = document.getElementById('result-mix-label');

  // Multi result elements
  const multiDrinkGrid = document.getElementById('multi-drink-grid');

  // Full bar result elements
  const fullbarGrid = document.getElementById('fullbar-grid');
  const totalItems = document.getElementById('total-items');

  // Shared result elements
  const resultServings = document.getElementById('result-servings');
  const resultPerPerson = document.getElementById('result-per-person');
  const resultDuration = document.getElementById('result-duration');
  const detailLink = document.getElementById('detail-link');
  const ctaText = document.getElementById('cta-text');

  // Update slider fill
  function updateSliderFill(slider, percentage) {
    slider.style.background = `linear-gradient(to right, var(--primary) 0%, var(--primary) ${percentage}%, var(--chocolate-10) ${percentage}%, var(--chocolate-10) 100%)`;
  }

  // Calculate consumption multiplier with decay
  function calculateConsumptionMultiplier(durationHours) {
    let total = 0;
    for (let hour = 0; hour < durationHours; hour++) {
      const decayIndex = Math.min(hour, HOURLY_DECAY.length - 1);
      total += HOURLY_DECAY[decayIndex];
    }
    return total;
  }

  // Calculate single drink quantity
  function calculateSingleDrink(item, guests, tier, duration, eventModifier) {
    const drinkingPct = DRINKING_PERCENTAGE[tier];
    const actualDrinkers = guests * drinkingPct;
    const consumptionMult = calculateConsumptionMultiplier(duration);
    const totalServings = Math.round(actualDrinkers * BASE_DRINKS_PER_HOUR * consumptionMult * eventModifier);
    const rawUnits = totalServings / item.servingsPerUnit;
    const unitsNeeded = Math.ceil(rawUnits * (1 + BUFFER_PERCENTAGE));
    return { totalServings, unitsNeeded };
  }

  // Main calculation
  function calculate() {
    const guests = selectedGuestCount.value;
    const tier = selectedGuestCount.tier;
    const duration = selectedDuration;
    const eventId = selectedEvent.id;
    const splits = EVENT_SPLITS[eventId] || EVENT_SPLITS.wedding;
    const drinkCount = selectedItems.length;
    const isMulti = drinkCount > 1;
    const varietyFactor = VARIETY_FACTORS[drinkCount] || 1.0;

    const totalSplit = selectedItems.reduce((sum, item) => sum + (splits[item.id] || 0.25), 0);

    let grandTotalServings = 0;
    let grandTotalUnits = 0;
    const results = [];

    selectedItems.forEach(item => {
      const modifier = selectedEvent.modifiers[item.id] || 1.0;
      const singleCalc = calculateSingleDrink(item, guests, tier, duration, modifier);

      let unitsNeeded = singleCalc.unitsNeeded;
      let servings = singleCalc.totalServings;

      if (isMulti) {
        const normalizedSplit = (splits[item.id] || 0.25) / totalSplit;
        unitsNeeded = Math.ceil(singleCalc.unitsNeeded * normalizedSplit * varietyFactor);
        servings = Math.round(singleCalc.totalServings * normalizedSplit * varietyFactor);

        if (drinkCount === 4) {
          const minUnits = MINIMUM_UNITS[item.id] || 4;
          unitsNeeded = Math.max(unitsNeeded, minUnits);
        }
      }

      grandTotalServings += servings;
      grandTotalUnits += unitsNeeded;

      results.push({
        item,
        unitsNeeded,
        servings,
      });
    });

    const perPerson = Math.round((grandTotalServings / guests) * 10) / 10;

    return { results, grandTotalServings, grandTotalUnits, perPerson, duration };
  }

  // Update UI with animation
  function updateResults() {
    const calc = calculate();
    const count = selectedItems.length;

    // Hide all result panels first
    singleResult.classList.add('hidden');
    multiResult.classList.add('hidden');
    fullbarResult.classList.add('hidden');

    if (count === 1) {
      singleResult.classList.remove('hidden');
      const result = calc.results[0];

      resultEmoji.style.transform = 'scale(1.1) rotate(5deg)';
      setTimeout(() => { resultEmoji.style.transform = 'scale(1) rotate(0deg)'; }, 200);

      resultEmoji.textContent = result.item.emoji;
      resultUnits.textContent = result.unitsNeeded;
      resultUnits.classList.add('result-animate');
      setTimeout(() => { resultUnits.classList.remove('result-animate'); }, 300);
      resultUnitLabel.textContent = result.unitsNeeded === 1 ? result.item.unitSingular : result.item.unit;
      resultMixLabel.textContent = `Calculated for ${result.item.name.toLowerCase()}`;

      const pageGuests = getNearestValidGuests(selectedGuestCount.value);
      const slug = `${result.item.id}-for-${selectedEvent.slug}-${pageGuests}-guests`;
      detailLink.href = `/${slug}?guests=${selectedGuestCount.value}&duration=${selectedDuration}`;
      ctaText.textContent = 'Get Full Breakdown';

    } else if (count <= 3) {
      multiResult.classList.remove('hidden');

      multiDrinkGrid.innerHTML = calc.results.map(r => `
        <div class="drink-card-item flex items-center justify-between">
          <div class="flex items-center gap-3">
            <span class="text-3xl">${r.item.emoji}</span>
            <span class="font-medium">${r.item.name}</span>
          </div>
          <div class="text-right">
            <div class="font-mono-luxe text-2xl font-bold">${r.unitsNeeded}</div>
            <div class="text-xs opacity-80">${r.item.unit}</div>
          </div>
        </div>
      `).join('');

      const drinks = selectedItems.map(i => i.id).join(',');
      const pageGuests = getNearestValidGuests(selectedGuestCount.value);
      detailLink.href = `/bar-setup/${selectedEvent.slug}-${pageGuests}-guests?guests=${selectedGuestCount.value}&drinks=${drinks}&duration=${selectedDuration}`;
      ctaText.textContent = 'Get Your Bar Breakdown';

    } else {
      fullbarResult.classList.remove('hidden');

      totalItems.textContent = calc.grandTotalUnits;

      fullbarGrid.innerHTML = calc.results.map(r => `
        <div class="drink-card-sm flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="text-xl">${r.item.emoji}</span>
            <span class="text-sm font-medium">${r.item.name}</span>
          </div>
          <div class="font-mono-luxe font-bold">${r.unitsNeeded}</div>
        </div>
      `).join('');

      const drinks = selectedItems.map(i => i.id).join(',');
      const pageGuestsFull = getNearestValidGuests(selectedGuestCount.value);
      detailLink.href = `/bar-setup/${selectedEvent.slug}-${pageGuestsFull}-guests?guests=${selectedGuestCount.value}&drinks=${drinks}&duration=${selectedDuration}`;
      ctaText.textContent = 'Get Your Complete Bar Guide';
    }

    // Update shared stats
    resultServings.textContent = calc.grandTotalServings;
    resultPerPerson.textContent = calc.perPerson;
    resultDuration.textContent = calc.duration;
  }

  // Update selection count display
  function updateSelectionCount() {
    const count = selectedItems.length;
    if (count === 1) {
      selectionCount.textContent = '1 drink selected';
      selectionCount.classList.remove('text-[var(--forest)]');
      selectionCount.classList.add('text-[var(--primary-dark)]');
    } else if (count === 4) {
      selectionCount.textContent = 'Full bar selected!';
      selectionCount.classList.add('text-[var(--forest)]');
      selectionCount.classList.remove('text-[var(--primary-dark)]');
    } else {
      selectionCount.textContent = `${count} drinks selected`;
      selectionCount.classList.remove('text-[var(--forest)]');
      selectionCount.classList.add('text-[var(--primary-dark)]');
    }
  }

  // Update duration hint based on event
  function updateDurationHint() {
    const eventName = selectedEvent.name.toLowerCase();
    if (selectedDuration === selectedEvent.defaultDuration) {
      durationHint.textContent = `Recommended for ${eventName}s`;
    } else if (selectedDuration === 1) {
      durationHint.textContent = 'Perfect for cocktail hour or toasts only';
    } else if (selectedDuration >= 6) {
      durationHint.textContent = 'Extended events may need mid-event restocking';
    } else {
      durationHint.textContent = `Adjusted from ${selectedEvent.defaultDuration}hr default`;
    }
  }

  // Update button states
  function updateCardStates() {
    drinkCards.forEach(card => {
      const itemId = card.dataset.item;
      const isSelected = selectedItems.some(i => i.id === itemId);
      const selectionDot = card.querySelector('.selection-dot');
      const icon = card.querySelector('.material-symbols-outlined');

      if (isSelected) {
        card.classList.remove('glass-card');
        card.classList.add('glass-card-selected');
        if (selectionDot) {
          selectionDot.style.background = 'var(--primary)';
          selectionDot.style.transform = 'scale(1)';
        }
        if (icon) {
          icon.classList.remove('text-[var(--chocolate-40)]');
          icon.classList.add('text-[var(--primary)]');
        }
      } else {
        card.classList.add('glass-card');
        card.classList.remove('glass-card-selected');
        if (selectionDot) {
          selectionDot.style.background = 'transparent';
          selectionDot.style.transform = 'scale(0)';
        }
        if (icon) {
          icon.classList.add('text-[var(--chocolate-40)]');
          icon.classList.remove('text-[var(--primary)]');
        }
      }
    });
  }

  // Event listeners - Drink cards
  drinkCards.forEach(card => {
    card.addEventListener('click', () => {
      const itemId = card.dataset.item;
      const item = itemsData.find(i => i.id === itemId);
      const isCurrentlySelected = selectedItems.some(i => i.id === itemId);

      if (isCurrentlySelected) {
        if (selectedItems.length === 1) {
          card.classList.add('animate-shake');
          setTimeout(() => card.classList.remove('animate-shake'), 300);
          return;
        }
        selectedItems = selectedItems.filter(i => i.id !== itemId);
      } else {
        selectedItems.push(item);
      }

      updateCardStates();
      updateSelectionCount();
      updateResults();
    });
  });

  eventSelect.addEventListener('change', (e) => {
    selectedEvent = eventsData.find(ev => ev.id === e.target.value);
    selectedDuration = selectedEvent.defaultDuration;
    durationSlider.value = selectedDuration;
    durationDisplay.textContent = selectedDuration;
    updateSliderFill(durationSlider, ((selectedDuration - 1) / 5) * 100);
    updateDurationHint();
    updateResults();
  });

  durationSlider.addEventListener('input', (e) => {
    selectedDuration = parseInt(e.target.value);
    durationDisplay.textContent = selectedDuration;
    updateSliderFill(durationSlider, ((selectedDuration - 1) / 5) * 100);
    updateDurationHint();
    updateResults();
  });

  guestSlider.addEventListener('input', (e) => {
    const sliderValue = parseFloat(e.target.value);
    const guestValue = sliderToGuests(sliderValue);
    selectedGuestCount = { value: guestValue, tier: getTierFromGuestCount(guestValue) };
    guestDisplay.textContent = guestValue;
    updateSliderFill(guestSlider, sliderValue); // Slider value IS the percentage now
    updateResults();
  });

  // Initial setup - 100 guests = 33.33%
  updateSliderFill(guestSlider, 33.33);
  updateSliderFill(durationSlider, ((5 - 1) / 5) * 100);
  updateDurationHint();
  updateResults();
</script>
