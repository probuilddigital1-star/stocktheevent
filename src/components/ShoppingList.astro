---
import type { ShoppingItem, Item } from '../lib/types';
import { getAffiliateLink } from '../lib/affiliates';

interface Props {
  items: ShoppingItem[];
  mainItem: Item;
}

const { items: shoppingItems, mainItem } = Astro.props;

// Separate main item from accessories
const mainItemEntry = shoppingItems[0];
const accessories = shoppingItems.slice(1);
---

<section class="py-16">
  <div class="max-w-3xl mx-auto px-4">
    <!-- Paper Texture Card -->
    <div class="paper-texture rounded-2xl border border-[var(--primary-30)] shadow-lg overflow-hidden">
      <!-- Inner decorative border -->
      <div class="m-3 border-2 border-[var(--primary-10)] rounded-xl p-6 md:p-8">
        <!-- Header -->
        <div class="text-center mb-8">
          <h2 class="font-display text-2xl md:text-3xl font-bold text-[var(--chocolate)] golden-underline-center">
            The Essentials
          </h2>
        </div>

        <!-- Shopping Items List -->
        <div class="space-y-0">
          <!-- Main Item -->
          <div class="shopping-item flex items-center gap-4 py-4 border-b border-[var(--primary-10)] group">
            <button
              class="checkbox-golden flex-shrink-0"
              data-checked="false"
              aria-label="Toggle item"
            >
              <svg class="checkmark w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                <path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <div class="flex-1 flex items-center justify-between">
              <div class="flex items-center gap-3">
                <span class="text-2xl">{mainItem.emoji}</span>
                <span class="font-medium text-[var(--chocolate)] text-lg group-hover:text-[var(--primary-dark)] transition-colors">
                  {mainItemEntry.quantity} {mainItemEntry.unit} {mainItemEntry.name}
                </span>
              </div>
              {(() => {
                const affiliateUrl = getAffiliateLink(mainItemEntry.name);
                return affiliateUrl ? (
                  <a
                    href={affiliateUrl}
                    target="_blank"
                    rel="noopener sponsored"
                    class="text-xs bg-[var(--primary-20)] hover:bg-[var(--primary-30)] text-[var(--primary-dark)] px-3 py-1 rounded-lg transition-colors font-medium"
                  >
                    Buy
                  </a>
                ) : null;
              })()}
            </div>
          </div>

          <!-- Accessories -->
          {accessories.map((item, index) => {
            const affiliateUrl = getAffiliateLink(item.name);
            return (
              <div class="shopping-item flex items-center gap-4 py-4 border-b border-[var(--primary-10)] last:border-b-0 group">
                <button
                  class="checkbox-golden flex-shrink-0"
                  data-checked="false"
                  aria-label="Toggle item"
                >
                  <svg class="checkmark w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                    <path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
                <div class="flex-1 flex items-center justify-between">
                  <span class="font-medium text-[var(--chocolate)] group-hover:text-[var(--primary-dark)] transition-colors">
                    {item.quantity} {item.unit} {item.name}
                    {item.notes && (
                      <span class="text-sm text-[var(--chocolate-40)] ml-2">({item.notes})</span>
                    )}
                  </span>
                  {affiliateUrl && (
                    <a
                      href={affiliateUrl}
                      target="_blank"
                      rel="noopener sponsored"
                      class="text-xs bg-[var(--primary-20)] hover:bg-[var(--primary-30)] text-[var(--primary-dark)] px-3 py-1 rounded-lg transition-colors font-medium"
                    >
                      Buy
                    </a>
                  )}
                </div>
              </div>
            );
          })}
        </div>

        <!-- Action Buttons -->
        <div class="flex gap-3 mt-8">
          <button
            id="copy-list"
            class="flex-1 py-4 px-6 bg-[var(--primary)] hover:bg-[var(--primary-dark)] text-white rounded-xl font-bold uppercase tracking-wider text-sm hover:scale-[1.02] active:scale-[0.98] transition-all shadow-md flex items-center justify-center gap-2"
          >
            <span class="material-symbols-outlined text-lg">content_copy</span>
            Copy List
          </button>
          <button
            id="email-list-btn"
            class="flex-1 py-4 px-6 bg-[var(--forest)] hover:bg-[var(--forest-dark)] text-white rounded-xl font-bold uppercase tracking-wider text-sm hover:scale-[1.02] active:scale-[0.98] transition-all shadow-md flex items-center justify-center gap-2"
          >
            <span class="material-symbols-outlined text-lg">mail</span>
            Email List
          </button>
        </div>

        <!-- Email Form (hidden by default) -->
        <div id="email-form-container" class="hidden mt-6 p-4 bg-[var(--cream-100)] rounded-xl border border-[var(--primary-20)]">
          <p class="text-sm text-[var(--chocolate)] mb-3 text-center">We'll send your complete list plus pro tips</p>
          <form id="email-list-form" class="flex flex-col sm:flex-row gap-3">
            <input
              type="email"
              name="email"
              placeholder="you@example.com"
              required
              class="flex-1 px-4 py-3 rounded-xl border border-[var(--primary-30)] focus:border-[var(--primary)] focus:ring-2 focus:ring-[var(--primary-20)] outline-none bg-white"
            />
            <button
              type="submit"
              class="bg-[var(--forest)] hover:bg-[var(--forest-dark)] text-white px-6 py-3 rounded-xl font-semibold transition-colors"
            >
              Send
            </button>
          </form>
          <p id="email-message" class="text-sm mt-3 text-center hidden"></p>
          <p class="text-xs text-[var(--chocolate-40)] mt-3 text-center">No spam, unsubscribe anytime</p>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  .checkbox-golden {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 2px solid var(--primary-40);
    background: transparent;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .checkbox-golden[data-checked="true"] {
    background: var(--primary-10);
    border-color: var(--primary);
  }

  .checkbox-golden .checkmark {
    color: var(--primary);
    opacity: 0;
    transform: scale(0);
    transition: all 0.2s ease;
  }

  .checkbox-golden[data-checked="true"] .checkmark {
    opacity: 1;
    transform: scale(1);
  }

  .shopping-item:has(.checkbox-golden[data-checked="true"]) span.font-medium {
    text-decoration: line-through;
    opacity: 0.5;
  }
</style>

<script define:vars={{ shoppingItems }}>
  // Checkbox toggle functionality
  document.querySelectorAll('.checkbox-golden').forEach(checkbox => {
    checkbox.addEventListener('click', () => {
      const isChecked = checkbox.dataset.checked === 'true';
      checkbox.dataset.checked = isChecked ? 'false' : 'true';
    });
  });

  // Copy list functionality
  document.getElementById('copy-list')?.addEventListener('click', () => {
    const text = shoppingItems
      .map(item => `${item.quantity} ${item.unit} - ${item.name}${item.notes ? ` (${item.notes})` : ''}`)
      .join('\n');

    navigator.clipboard.writeText(text).then(() => {
      const btn = document.getElementById('copy-list');
      if (btn) {
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<span class="material-symbols-outlined text-lg">check</span> Copied!';
        setTimeout(() => { btn.innerHTML = originalHTML; }, 2000);
      }
    });
  });

  // Email list toggle
  document.getElementById('email-list-btn')?.addEventListener('click', () => {
    const container = document.getElementById('email-form-container');
    container?.classList.toggle('hidden');
  });

  // Email form submission
  const emailForm = document.getElementById('email-list-form');
  emailForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const emailInput = emailForm.querySelector('input[name="email"]');
    const email = emailInput ? emailInput.value : '';
    const message = document.getElementById('email-message');

    const payload = {
      email: email,
      shoppingList: shoppingItems,
      pageUrl: window.location.href,
      timestamp: new Date().toISOString(),
      source: 'shopping-list'
    };

    try {
      const response = await fetch('https://zax76.app.n8n.cloud/webhook/email-signup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (response.ok) {
        if (message) {
          message.textContent = 'Check your inbox!';
          message.className = 'text-sm mt-3 text-center text-[var(--forest)]';
          message.classList.remove('hidden');
        }
        emailForm.reset();
      } else {
        throw new Error('Failed');
      }
    } catch (err) {
      if (message) {
        message.textContent = 'Something went wrong. Try again?';
        message.className = 'text-sm mt-3 text-center text-[var(--wine)]';
        message.classList.remove('hidden');
      }
    }
  });
</script>
