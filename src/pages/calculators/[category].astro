---
import * as fs from 'fs';
import * as path from 'path';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { items } from '../../data/items';
import { events } from '../../data/events';

// Event emoji mapping (keys match event.id)
const eventEmojis: Record<string, string> = {
  wedding: 'ðŸ’’',
  graduation: 'ðŸŽ“',
  corporate: 'ðŸ’¼',
  birthday: 'ðŸŽ‚',
  'super-bowl': 'ðŸˆ',
  'holiday-party': 'ðŸŽ„',
  'wedding-shower': 'ðŸ’',
  'march-madness': 'ðŸ€',
  'fourth-of-july': 'ðŸŽ†',
  'labor-day': 'â˜€ï¸',
  'halloween': 'ðŸŽƒ',
  'thanksgiving': 'ðŸ¦ƒ',
  'new-years-eve': 'ðŸ¥³',
};

export function getStaticPaths() {
  const itemPaths = items.map(item => ({
    params: { category: item.id },
    props: { type: 'item', data: item },
  }));

  const eventPaths = events.map(event => ({
    params: { category: event.id },
    props: { type: 'event', data: event },
  }));

  return [...itemPaths, ...eventPaths];
}

const { category } = Astro.params;
const { type, data } = Astro.props;

// Read all calculator JSON files directly
const calcDir = path.join(process.cwd(), 'src/content/calculators');
const files = fs.readdirSync(calcDir).filter(f => f.endsWith('.json') && !f.startsWith('_'));
const allCalculators = files.map(file => {
  const pageData = JSON.parse(fs.readFileSync(path.join(calcDir, file), 'utf-8'));
  return {
    slug: file.replace('.json', ''),
    item: pageData.item.id,
    event: pageData.event.id,
    guests: pageData.guestCount.value
  };
});

// Filter calculators based on category type
let filteredCalculators;
if (type === 'item') {
  filteredCalculators = allCalculators.filter((c: { item: string }) => c.item === category);
} else {
  filteredCalculators = allCalculators.filter((c: { event: string }) => c.event === category);
}

// Get display info
const isItem = type === 'item';
const title = isItem ? `${data.name} Calculators` : `${data.name} Drink Calculators`;
const emoji = isItem ? data.emoji : (eventEmojis[data.id] || 'ðŸŽ‰');
const description = isItem
  ? `Calculate how much ${data.name.toLowerCase()} you need for any event and guest count.`
  : `Calculate how much wine, beer, champagne, or spirits you need for your ${data.name.toLowerCase()}.`;
---

<BaseLayout
  title={`${title} | StockTheEvent`}
  description={description}
>
  <!-- Hero -->
  <section class="py-12 md:py-16 bg-gradient-to-b from-amber-50 via-orange-50/30 to-white">
    <div class="max-w-5xl mx-auto px-4">
      <!-- Breadcrumb -->
      <nav class="mb-6 text-sm text-slate-500 text-center">
        <a href="/" class="hover:text-emerald-600 transition-colors">Home</a>
        <span class="mx-2">/</span>
        <a href="/calculators" class="hover:text-emerald-600 transition-colors">Calculators</a>
        <span class="mx-2">/</span>
        <span class="text-slate-700">{isItem ? data.name : data.name}</span>
      </nav>

      <div class="text-center">
        <div class="text-7xl mb-6">{emoji}</div>
        <h1 class="font-display text-3xl md:text-4xl lg:text-5xl font-bold text-slate-900 mb-4">
          {title}
        </h1>
        <p class="text-xl text-slate-600 max-w-2xl mx-auto">
          {description}
        </p>
        <p class="text-amber-600 font-semibold mt-4">
          {filteredCalculators.length} calculators available
        </p>
      </div>
    </div>
  </section>

  <!-- Pro Tip (for events) or Serving Info (for items) -->
  {isItem ? (
    <section class="py-8 bg-white border-b border-slate-100">
      <div class="max-w-3xl mx-auto px-4 text-center">
        <div class="inline-flex items-center gap-3 bg-amber-50 px-6 py-3 rounded-full">
          <span class="text-2xl">{data.emoji}</span>
          <span class="text-slate-700">
            <strong>{data.servingsPerUnit} servings</strong> per {data.unitSingular}
          </span>
        </div>
      </div>
    </section>
  ) : (
    <section class="py-8 bg-white border-b border-slate-100">
      <div class="max-w-3xl mx-auto px-4 text-center">
        <div class="bg-emerald-50 px-6 py-4 rounded-2xl">
          <p class="text-emerald-800">
            <span class="font-semibold">Pro tip:</span> {data.proTips[0]}
          </p>
        </div>
      </div>
    </section>
  )}

  <!-- Calculator Grid -->
  <section class="py-12 bg-white">
    <div class="max-w-5xl mx-auto px-4">
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-5">
        {filteredCalculators.map((calc: { slug: string; item: string; event: string; guests: number }) => {
          const item = items.find(i => i.id === calc.item);
          const event = events.find(e => e.id === calc.event);
          return (
            <a
              href={`/${calc.slug}`}
              class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm hover:shadow-lg hover:border-emerald-300 hover:scale-[1.02] transition-all group"
            >
              <div class="flex items-center gap-4">
                <span class="text-4xl group-hover:scale-110 transition-transform">{item?.emoji}</span>
                <div class="flex-1 min-w-0">
                  <div class="font-semibold text-slate-900 group-hover:text-emerald-600 truncate">
                    {isItem ? event?.name : item?.name}
                  </div>
                  <div class="text-sm text-slate-500">
                    <span class="font-medium text-slate-700">{calc.guests}</span> guests
                  </div>
                </div>
                <div class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center group-hover:bg-emerald-100 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400 group-hover:text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                  </svg>
                </div>
              </div>
            </a>
          );
        })}
      </div>
    </div>
  </section>

  <!-- CTA Section -->
  <section class="py-16 bg-gradient-to-br from-amber-500 via-orange-500 to-orange-600 relative overflow-hidden">
    <div class="absolute top-0 left-0 w-64 h-64 bg-white/10 rounded-full -translate-x-1/2 -translate-y-1/2"></div>
    <div class="absolute bottom-0 right-0 w-48 h-48 bg-white/10 rounded-full translate-x-1/2 translate-y-1/2"></div>

    <div class="max-w-3xl mx-auto px-4 text-center relative z-10">
      <h2 class="font-display text-3xl font-bold text-white mb-4">
        Need a different calculation?
      </h2>
      <p class="text-amber-100 mb-8 text-lg">
        Use our interactive calculator for any combination
      </p>
      <div class="flex flex-wrap justify-center gap-4">
        <a
          href="/"
          class="inline-block bg-white text-amber-600 px-8 py-4 rounded-xl font-bold hover:bg-amber-50 hover:scale-105 transition-all shadow-xl"
        >
          Interactive Calculator
        </a>
        <a
          href="/calculators"
          class="inline-block bg-white/20 text-white px-8 py-4 rounded-xl font-bold hover:bg-white/30 hover:scale-105 transition-all"
        >
          All Categories
        </a>
      </div>
    </div>
  </section>
</BaseLayout>
